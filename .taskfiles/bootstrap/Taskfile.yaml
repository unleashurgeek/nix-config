# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: "3"
tasks:
  generate:
    desc: Generate ssh keys and hardware configuration for the remote host [SSH_PORT=22]
    requires:
      vars:
        - TARGET
        - HOSTNAME
    vars:
      SSH_PORT: '{{.SSH_PORT | default "22"}}'
    silent: true
    cmds:
      - task: ssh
      - task: hardware
  ssh:
    desc: Generate the ssh keys for the remote host [SSH_PORT=22]
    requires:
      vars:
        - TARGET
        - HOSTNAME
    vars:
      SSH_PORT: '{{.SSH_PORT | default "22"}}'
    silent: true
    cmds:
      - ssh -oport={{.SSH_PORT}} -t {{.TARGET}} "sudo ssh-keygen -t ed25519 -N \"\" -C \"root@{{.HOSTNAME}}\" -f ~/ssh_host_ed25519_key"
      - ssh -oport={{.SSH_PORT}} -t {{.TARGET}} "cat ~/ssh_host_ed25519_key.pub" > ./hosts/{{.HOSTNAME}}/ssh_host_ed25519_key.pub
      - echo "public key:"
      - cat hosts/{{.HOSTNAME}}/ssh_host_ed25519_key.pub
      - echo "age key:"
      - ssh-to-age -i hosts/{{.HOSTNAME}}/ssh_host_ed25519_key.pub
  repo:
    desc: Setup the nix-config repo for the remote host [SSH_PORT=22]
    requires:
      vars:
        - TARGET
    vars:
      TEMPDIR:
        sh: mktemp -d
      SSH_PORT: '{{.SSH_PORT | default "22"}}'
    silent: true
    cmds:
      - mkdir {{.TEMPDIR}}/.nix-config
      - cp -r ./ {{.TEMPDIR}}/.nix-config
      - cd {{.TEMPDIR}}
      - cmd: git branch | grep --color=auto -v 'main' | grep --color=auto -v "$(git branch --show-current)" | xargs git branch -D
        ignore_error: true
      - rsync -rz --delete --exclude=result --exclude=.direnv --exclude=.pre-commit-config.yaml --rsh="ssh -oport={{.SSH_PORT}}" "{{.TEMPDIR}}/.nix-config" "{{.TARGET}}:~/"
      - echo "repo copied to {{.TARGET}} at ~/.nix-config"
  hardware:
    desc: Generate the facter json file for hardware configuration [SSH_PORT=22]
    requires:
      vars:
        - TARGET
        - HOSTNAME
    vars:
      SSH_PORT: '{{.SSH_PORT | default "22"}}'
    cmds:
      - ssh -oport={{.SSH_PORT}} -t {{.TARGET}} "sudo nix run nixpkgs#nixos-facter -- -o ~/facter.json"
      - ssh -oport={{.SSH_PORT}} -t {{.TARGET}} "sudo cat ~/facter.json" > ./hosts/{{.HOSTNAME}}/facter.json
  disk:
    desc: Partition the disks based on disko configuration
    prompt: This will reformat all target disks in the disko config... Do you want to continue?
    requires:
      vars:
        - HOSTNAME
    cmds:
      - sudo disko --mode destroy,format,mount --flake .#{{.HOSTNAME}} --yes-wipe-all-disks
  install:
    desc: Move ssh keys + nix-config to persist directory and then run the nixos-install [USER=kyle] [UID=1000]
    requires:
      vars:
        - HOSTNAME
    vars:
      SSH_KEY: ~/ssh_host_ed25519_key
      USER: '{{.USER | default "kyle"}}'
      UID: "{{.UID | default 1000}}"
      NIX_CONFIG_DIR: "/mnt/persist/home/{{.USER}}/.nix-config"
    preconditions:
      - test -f {{.SSH_KEY}}
      - test -f {{.SSH_KEY}}.pub
      - test $(stat -c '%U' {{.SSH_KEY}}) = root
      - test $(stat -c '%a' {{.SSH_KEY}}) -eq 600
    cmds:
      - echo "persisting ssh keys..."
      - sudo mkdir -p "/mnt/persist/etc/ssh"
      - sudo mv {{.SSH_KEY}} /mnt/persist/etc/ssh/ssh_host_ed25519_key
      - sudo mv {{.SSH_KEY}}.pub /mnt/persist/etc/ssh/ssh_host_ed25519_key.pub
      - echo "Moving nix-config repo to user home..."
      - sudo mkdir -p /mnt/persist/home/{{.USER}}
      - sudo chown {{.UID}}:{{.UID}} /mnt/persist/home/{{.USER}}
      - cd ../
      - mv .nix-config /mnt/persist/home/{{.USER}}/.nix-config
      - echo "Installing nixos..."
      - sudo nixos-install --no-channel-copy --no-root-password --root '/mnt' --flake {{.NIX_CONFIG_DIR}}#{{.HOSTNAME}}
      - echo "Installation complete..."
